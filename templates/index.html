<html>

<head meta name="viewport" content="width=device-width">
  <title> Project TES</title>
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

</head>



<style type="text/css">
  /* initial border setting for coin list and upon hover*/

  /* .higlight is an object to be pass on a class attribute, rembember an element assign to a class on this will directly affect the attribute without the specifier (eg td tr*/
  .highlight {
    border: 2px solid rgb(47, 0, 255);
  }

  .normal td {
    border-color: rgb(240, 234, 234);
  }
</style>


<style>
  .chart_resize {
    border: 2px solid rgb(177, 170, 170);
    Height: 85%;
    width: 80%;
    position: relative;
  }

  .table_div_test {
    border: 2px solid rgb(178, 176, 176);
    position: absolute;
    left: 81%;
    top: 55px;
    Height: 83.5%;
    width: 17.5%;
  }


  .table_div_test thead {
    height: 50%;
    position: sticky;
    top: 0;
    background-color: rgb(66, 6, 6);
    z-index: 999;
    width: 100%;

  }

  table_div_test th {

    white-space: nowrap;
    padding: 7px;

    height: 24px;


  }

  .table_div_test tbody {


    width: 100%;
    margin-top: 30px;
    overflow-y: scroll;


  }


  .table_div_test tbl {
    width: 100%;
    display: grid;
    grid-template-columns: 20% 30% 20% 30%;
    grid-template-rows: 30px auto;
    grid-gap: 7px;
  }

  .table_div_test tr {
    background-color: white;
    height: 24px;
  }

  .table_div_test tr:hover {
    background-color: rgb(227, 222, 222);
  }


  .table_div_test td {
    overflow: auto;
    white-space: nowrap;
    padding: 7px;
    grid-row: 2 / span 1;
  }


  div.date_div_test {
    border: 2px solid rgb(255, 255, 255);
    position: absolute;
    left: 85%;
    top: 92%;
    Height: 5%;
    width: 15%;
  }




  div.date_div_test1 {
    border: 2px solid rgb(255, 255, 255);
    position: absolute;
    left: 82%;
    top: 92%;
    Height: 5%;
    width: 2%;
  }


  .redtext {
    color: red
  }

  .greentext {
    color: rgb(2, 153, 2)
  }
</style>

<body>
  <h2 style="font-family:'Century Gothic'"> {{title}} </h2>

  <div id="chart" class="chart_resize"> </div>

  <!--table for pairs <div class=" table_div_test"></div>--->

  <div id="trades">

    <p> </p>
    <div id="Output_box" style="width: 100px; float:left;"> {{symbols[0][0]}} </div>
    <div id="Output_box2" style="width: 150px; float:left;"> {{symbols[0][2]}} </div>
    <div id="Output_box3" style="width: 300px; float:left;"> {{symbols[0][1]}} </div>
    <div id="table_update" style="width: 300px; float:left; position: absolute; top: 35px; left: 81%; font-style: italic;">  </div>

  


    <div id="closed_data">

    </div>



    <div id="date" class="date_div_test1">
      Date:
    </div>

    <div id="date" class="date_div_test">

      <input type="date" id="datepicker" name='from' size='10' value="" />
      <button type="button" id="prev_day_button">prev</button>
      <button type="button" id="next_day_button">next</button>
      <button type="button" id="daily_price_update" style="position:relative; bottom: -20%; left: 42%">update
        table</button>

    </div>











  </div>

  <div>
    <h2> </h2>

    <!--table for pairs--->
    <div id="my_balances" style="overflow-y: scroll; height:83.5%;" class=table_div_test>


      <table id="table_pair" class="tbl" border=1 frame=void rules=rows>

        <thead>
          <tr style="background-color: rgb(227, 222, 222)">
            <th text-align: left;>Symbols</th>
            <th>Last</th>
            <th>Chg%</th>
            <th>Vol</th>
          </tr>

        </thead>

        <tbody>

          {% for pairs in symbols %}

          <tr data value={{pairs[0]}} class="normal" onclick="onRow(this.id)" id={{pairs[0]}}>

            <td> {{pairs[0]}} </td>
            <td> {{pairs[2]}} </td>
            <td> {{pairs[4]}}% </td>
            <td> {{pairs[3]}} </td>



          </tr>


          {% endfor%}
        </tbody>

      </table>

    </div>

  </div>

  <form action="/history_test" method="post" id="get_history">
    <input type="hidden" name="symbol" value="BTCUSDT" />

  </form>





  <script>
    var app_host = '{{app_host}}';
    var app_port = '{{app_port}}';
    var base_url = 'http://'+ '{{app_host}}' + ':'+ '{{app_port}}' + '/history'
    console.log(base_url);

  </script>

  <!-- This script is run at the start of the page, it initializes the TV's lightweight chart   -->
  <script src="{{url_for('static', filename='chart.js')}}">
  </script>

  <!-- This script sets the default value of input-date on the page load  -->
  <script>
    document.getElementById("datepicker").valueAsDate = new Date();
    var prev_day = document.getElementById("datepicker").valueAsDate;
    

  </script>


  <!-- Function to request historical data-->
  <script>

    function request_for_historical_data(row) {
      //CoinPair that was clicked

      //const {performance} = require('perf_hooks');

      var start = Date.now();

      //*************************
      document.getElementById('Output_box').innerHTML = row.getAttribute('value')



      document.getElementById("get_history").setAttribute('value', row.innerHTML)
      var start = Date.now();
      console.log(row.getAttribute('id'));
      var date_input = document.getElementById("datepicker");
      //alert(date_input)



    var base_url = 'http://'+ '{{app_host}}' + ':'+ '{{app_port}}' + '/history_test';
 
     
      //Update chart historicaldata  
      fetch(base_url,
        {
          method: "POST",
          headers: { "symbol": row.getAttribute('value'), "date_input": date_input.value },


        })

        .then((r) => r.json())
        .then((response) => {

          //console.log(Date.now());
          candleSeries.setData(response);


          document.getElementById('Output_box2').innerHTML = response[response.length - 1].close;
         // console.log(response);
          var timestamp = response[response.length - 1].time * 1000; //had to convert it back to miliseconds, this was manipulated in backend fetch
          document.getElementById('Output_box3').innerHTML = new Date(timestamp);

         // console.log(Date.now());


        })




    }


  </script>

  <!-- This script listens when the pages is fully load then attaches event listener to the table rows when click   -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      //console.log(rows);
      add_click_lister_table();


    });

  </script>

  <!-- This script contains the function that attach event listener to table rows upon click  -->
  <script>


    function add_click_lister_table() {

      //alert('im working');
      
      var tbody_row = document.querySelector("tbody");
      const rows = tbody_row.querySelectorAll("tr");
      rows.forEach(row => {

        row.addEventListener("click", () => {

          request_for_historical_data(row);



          var end = Date.now();
          //console.log(`Execution time: ${end - start} ms`);
          //console.log("test");

          var root_websocket = "wss://stream.binance.com:9443/ws/";
          var symbol = row.innerText;
          symbol = symbol.toLowerCase();
          var time_frame = "@kline_1D";
          var symbol_websocket = root_websocket.concat(symbol, time_frame);
          //console.log(symbol_websocket);


          var binancesocket = new WebSocket(symbol_websocket);

          binancesocket.onmessage = function (event) {
            message = JSON.parse(event.data)

            candlestick = message.k;


            candleSeries.update({

              time: candlestick.t / 1000,
              open: candlestick.o,
              high: candlestick.h,
              low: candlestick.l,
              close: candlestick.c



            })
          }




        });

      });

    }

  </script>

  <!-- This script contains a function that highlights the row of the table upon click -> blue -->
  <script>




    function highlight_row_routine() {
      let currentRow = null;

      var tbody_row = document.querySelector("tbody");
      const rows = tbody_row.querySelectorAll("tr");
     

      // add event listener for clicking on rows
      rows.forEach(row => {
        row.addEventListener("click", () => {
          if (currentRow) {
            currentRow.classList.remove("highlight");
            currentRow.classList.add("normal");
          }
          currentRow = row;
          currentRow.classList.remove("normal");
          currentRow.classList.add("highlight");
        });
      });

      // add event listener for keyboard arrow keys
      document.addEventListener("keydown", function (event) {
        if (event.key === "ArrowUp" || event.key === "ArrowDown") {
          event.preventDefault()
          // check if a row is currently selected
          if (currentRow) {
            let newRow = null;
            if (event.key === "ArrowUp") {
              // move selection to the previous row
              newRow = currentRow.previousElementSibling;
            } else {
              // move selection to the next row
              newRow = currentRow.nextElementSibling;
            }
            // check if the new row exists
            if (newRow) {
              // remove highlighting from the previous selected row
              currentRow.classList.remove("highlight");

              // add highlighting to the new row
              newRow.classList.add("highlight");
              currentRow = newRow;
              // scroll the new row into view
              currentRow.scrollIntoView({ behavior: "auto", block: "nearest" });
            }
          }
          //for arrow down selector
          request_for_historical_data(currentRow);
        }
      });
    }







    highlight_row_routine();


  </script>


  <!--This script add event listener to the prev and next day button, so it can adjust the input-date -->
  <script>


    let btn_down = document.getElementById("prev_day_button");
    btn_down.addEventListener('click', event => {

      // Get the input element
      var input = document.getElementById("datepicker");


      //alert(prev_day);

      // Get the current input value
      var currentValue = input.value;

      // Convert the current input value to a JavaScript Date object
      var currentDate = new Date(currentValue);

      // Increase the date by one day
      currentDate.setDate(currentDate.getDate() - 1);

      // Convert the new date back to a string in the format "yyyy-mm-dd"
      var newValue = currentDate.toISOString().slice(0, 10);

      // Update the input value
      input.value = newValue;







      // Create a new "change" event
      var event = new Event("change");

      // Dispatch the event on the input
      input.dispatchEvent(event);

      //console.log(new Date(new Date().setDate(new Date().getDate() - 5)));
      //alert((new Date(new Date().setDate(new Date().getDate() - 5))));
      //alert(document.getElementById("datepicker").valueAsDate -5);


    });


    let btn_up = document.getElementById("next_day_button");
    btn_up.addEventListener('click', event => {

      // Get the input element
      var input = document.getElementById("datepicker");


      // Get the current input value
      var currentValue = input.value;

      // Convert the current input value to a JavaScript Date object
      var currentDate = new Date(currentValue);

      // Increase the date by one day
      currentDate.setDate(currentDate.getDate() + 1);

      // Convert the new date back to a string in the format "yyyy-mm-dd"
      var newValue = currentDate.toISOString().slice(0, 10);

      // Update the input value
      input.value = newValue;

      // Create a new "change" event
      var event = new Event("change");

      // Dispatch the event on the input
      input.dispatchEvent(event);





    });
  </script>

  <!-- This script automatically adjust webpagae's object depending on its screen size, it adds event listener when the screen of the user is change or resize   -->
  <script>
    window.addEventListener('resize', function (event) {
      // do stuff here

      var container = document.getElementById('chart');
      var width = container.offsetWidth - 10;
      var height = container.offsetHeight - 10;
      chart.resize(width, height);


    });


  </script>

  <!-- This script used to decorize a certain column of the table, and change the color depending on its value, red - negative, green - positive  -->
  <script>



    function update_color() {

      var table = document.getElementById("table_pair");

      for (var i = 1, row; row = table.rows[i]; i++) {

        var y = row.cells[2].innerHTML.replace("%", "");
        y = +y;
        if (+y >= 0) {
          //console.log('positive');
          row.cells[2].className = "greentext"
        }
        else {
          //console.log('negative');
          row.cells[2].className = "redtext"
        }



      }
    }

    update_color();
  </script>





  <script>

    var input = document.getElementById("datepicker");


    //alert(prev_day);

    // Add an event listener for the "change" event
    input.addEventListener("change", function () {
      //alert('change in date');
      //alert(document.getElementsByClassName('highlight')[0].innerHTML);
      
      //sets update table flag no null every change on date
      document.getElementById("table_update").innerHTML = "";
      var current_row_selected = document.getElementsByClassName('highlight')[0];
      request_for_historical_data(current_row_selected);
    });


  </script>

  <!-- This script is runs when it update table is click, function such as change the content of the table,etc   -->
  <script>

    // Change on date handler

    var input = document.getElementById("datepicker");
    var daily_price_change_request = document.getElementById("daily_price_update");

    //alert(prev_day);

    // Add an event listener for the "change" event
    daily_price_change_request.addEventListener("click", function () {

      
      document.getElementById("table_update").innerHTML = "table updating...";
      // Code to execute when the input's value changes

      //Container for prev-day
      var currentValue2 = input.value;
      var currentDate2 = new Date(currentValue2);
      currentDate2.setDate(currentDate2.getDate() - 1);
      var newValue2 = currentDate2.toISOString().slice(0, 10);
      prev_day = newValue2;


      var base_url = 'http://'+ '{{app_host}}' + ':'+ '{{app_port}}' + '/update_prices';
      //console.log(base_url);
      //Update all pairs historicaldata  
      fetch(base_url,

        {
          method: "POST",
          headers: { "present_day": input.value, "prev_day": prev_day },


        })

        .then((r) => r.json())
        .then((response) => {


          console.log(response);


          //delete all rows in present table
          var table = document.querySelector("#table_pair tbody");
          


          var rowCount = table.rows.length;
          for (var i = 0; i < rowCount; i++) {

            table.deleteRow(0);

          }
          
          
          //Update table with new data from new time/day
          //var table = document.getElementById("table_pair");
          var newData = response;

          for (var i = 0; i < newData.length; i++) {
            var row = table.insertRow(i);
            row.classList.add("normal");
            row.setAttribute('id', 'row' + (i + 1));
            row.setAttribute('onclick', 'onRow(this.id)');
            row.setAttribute('value', newData[i][0]);

            var cell = row.insertCell(0);
            cell.innerHTML = newData[i][0];

            var cell = row.insertCell(1);
            cell.innerHTML = newData[i][2];

            var cell = row.insertCell(2);
            cell.innerHTML = newData[i][4] + "%";


            var cell = row.insertCell(3);
            cell.innerHTML = newData[i][3];

          }

          add_click_lister_table();
          update_color();
          highlight_row_routine();
          document.getElementById("table_update").innerHTML = "table updated.";





        });




    });








  </script>

  <!-- This script is for the sorting algorithm of the table, each column header is assigned an event listener   -->
  <script>

    // Get the table element
    var table = document.getElementById("table_pair");

    // Create a variable to keep track of the sort order (true = ascending, false = descending)
    var sortAscending = true;



    // Listen for double clicks on all the header elements
    var headers = table.getElementsByTagName("th");
    for (var i = 0; i < headers.length; i++) {
      headers[i].addEventListener("dblclick", function (event) {
        // Get the index of the clicked header
        var headerIndex = Array.prototype.indexOf.call(event.target.parentNode.children, event.target);
        // Get all the rows in the table (excluding the header row)
        var rows = table.getElementsByTagName("tr");
        var rowArray = [];
        for (var i = 1; i < rows.length; i++) {
          rowArray.push(rows[i]);
        }
        // Sort the rows based on the content of the header that was clicked
        rowArray.sort(function (a, b) {
          var cellA = a.getElementsByTagName("td")[headerIndex].innerHTML;
          var cellB = b.getElementsByTagName("td")[headerIndex].innerHTML;
          if (headerIndex === 1 || headerIndex === 2) {
            cellA = parseFloat(cellA);
            cellB = parseFloat(cellB);
          }
          if (sortAscending) {
            return cellA > cellB ? 1 : -1;
          } else {
            return cellA < cellB ? 1 : -1;
          }
        });
        // Remove the selected class from all rows
        for (var i = 0; i < rows.length; i++) {
          rows[i].classList.remove("selected");
        }
        // Re-add the sorted rows to the table
        table.tBodies[0].innerHTML = "";
        for (var i = 0; i < rowArray.length; i++) {
          table.tBodies[0].appendChild(rowArray[i]);
        }
        // Toggle the sort order
        sortAscending = !sortAscending;
      });
    }

    // Listen for clicks on all the rows
    var rows = table.getElementsByTagName("tr");
    for (var i = 0; i < rows.length; i++) {
      rows[i].addEventListener("click", function (event) {
        // Remove the selected class from all rows
        for (var i = 0; i < rows.length; i++) {
          rows[i].classList.remove();
        }
        // Add the selected class to the clicked row
        event.target.parentNode.classList.add();
      });
    }


  </script>




</body>

</html>